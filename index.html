<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- Made by Youssef Chigane -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Suivi Engagements & KPI</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <!-- SheetJS (XLSX export) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
      --bg-solid: #f0f2f5;
      --card: #ffffff;
      --text: #1a1a2e;
      --muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1);
      --shadow-lg: 0 20px 25px -5px rgba(0,0,0,.1), 0 8px 10px -6px rgba(0,0,0,.1);
      --row-gap: 14px;

      --primary: #4f46e5;
      --primary-light: #6366f1;
      --primary-dark: #4338ca;

      --state-none-bg: #ffffff;
      --state-none-br: #e2e8f0;
      --state-partial-bg: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      --state-partial-br: #60a5fa;
      --state-done-bg: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      --state-done-br: #34d399;

      --pill-bg: #f1f5f9;
      --pill-br: #cbd5e1;
    }

    *{ box-sizing: border-box; }

    body{
      background: var(--bg-solid);
      background-image: var(--bg);
      background-attachment: fixed;
      color: var(--text);
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif;
      min-height: 100vh;
    }

    /* Header bar */
    .header-bar{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      padding: 20px 0;
      margin-bottom: 24px;
      box-shadow: var(--shadow-lg);
    }
    .header-bar h4{
      color: #fff;
      font-weight: 900;
      font-size: 1.5rem;
      margin: 0;
      text-shadow: 0 2px 4px rgba(0,0,0,.1);
    }
    .header-bar .subtitle{
      color: rgba(255,255,255,.85);
      font-size: .9rem;
      margin-top: 4px;
    }

    .app-shell{
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px 60px;
    }

    .topbar{
      background: var(--card);
      border: none;
      border-radius: 20px;
      box-shadow: var(--shadow-lg);
      padding: 24px;
      margin-bottom: 20px;
    }

    .stats-grid{
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 16px;
    }
    @media (max-width: 992px){
      .stats-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 576px){
      .stats-grid{ grid-template-columns: 1fr; }
    }
    .stat{
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px 20px;
      transition: transform .2s ease, box-shadow .2s ease;
      position: relative;
      overflow: hidden;
    }
    .stat::before{
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 4px; height: 100%;
      background: var(--primary);
      border-radius: 4px 0 0 4px;
    }
    .stat:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .stat .label{
      color: var(--muted);
      font-size: .8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .5px;
    }
    .stat .value{
      font-size: 1.75rem;
      font-weight: 800;
      margin-top: 4px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .controlbar{
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .upload-compact{
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .upload-compact .form-control{
      max-width: 280px;
      border-radius: 10px;
      border: 2px solid var(--border);
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .upload-compact .form-control:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(79,70,229,.1);
    }

    .btn{
      font-weight: 600;
      border-radius: 10px;
      padding: 8px 16px;
      transition: all .2s ease;
    }
    .btn-primary{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border: none;
      box-shadow: 0 4px 14px rgba(79,70,229,.4);
    }
    .btn-primary:hover{
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(79,70,229,.5);
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
    }
    .btn-success{
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
      border: none;
      box-shadow: 0 4px 14px rgba(16,185,129,.4);
    }
    .btn-success:hover{
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(16,185,129,.5);
    }

    .filters{
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .filters .form-control, .filters .form-select{
      min-width: 200px;
      border-radius: 10px;
      border: 2px solid var(--border);
      font-weight: 500;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .filters .form-control:focus, .filters .form-select:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(79,70,229,.1);
    }

    .table-wrap{
      background: var(--card);
      border: none;
      border-radius: 20px;
      box-shadow: var(--shadow-lg);
      padding: 24px;
    }

    table.table{ color: var(--text) !important; }
    table.table td, table.table th{ color: var(--text) !important; vertical-align: top; }
    .table thead th{
      color: var(--muted) !important;
      font-weight: 700;
      font-size: .85rem;
      text-transform: uppercase;
      letter-spacing: .5px;
      border-bottom: 2px solid var(--border) !important;
      padding-bottom: 16px;
    }

    .row-card{
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      background: var(--state-none-bg);
      cursor: pointer;
      transition: all .25s cubic-bezier(.4,0,.2,1);
      box-shadow: 0 1px 3px rgba(0,0,0,.05);
      position: relative;
    }
    .row-card::after{
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 16px;
      opacity: 0;
      transition: opacity .25s ease;
      pointer-events: none;
      box-shadow: 0 20px 40px rgba(79,70,229,.15);
    }
    .row-card:hover{
      transform: translateY(-4px);
      border-color: var(--primary-light);
    }
    .row-card:hover::after{
      opacity: 1;
    }
    .row-card.state-none{ background: var(--state-none-bg); border-color: var(--state-none-br); }
    .row-card.state-partial{ background: var(--state-partial-bg); border-color: var(--state-partial-br); }
    .row-card.state-done{ background: var(--state-done-bg); border-color: var(--state-done-br); }

    .ref-badge{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      padding: 8px 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border: 1px solid var(--pill-br);
      color: var(--text);
      white-space: nowrap;
      font-size: .9rem;
      box-shadow: 0 2px 4px rgba(0,0,0,.05);
    }

    .mini-state{
      display: inline-block;
      width: 10px; height: 10px;
      border-radius: 999px;
      background: #d1d5db;
      box-shadow: 0 0 0 3px rgba(209,213,219,.3);
    }
    .state-none .mini-state{ background: #94a3b8; box-shadow: 0 0 0 3px rgba(148,163,184,.3); }
    .state-partial .mini-state{ background: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.3); }
    .state-done .mini-state{ background: #10b981; box-shadow: 0 0 0 3px rgba(16,185,129,.3); }

    .engagement-text{ font-weight: 600; line-height: 1.5; word-break: break-word; color: #334155; }

    .card-grid{
      display: grid;
      grid-template-columns: 140px 1fr 1.2fr;
      gap: 20px;
    }
    @media (max-width: 992px){
      .card-grid{ grid-template-columns: 1fr; }
    }
    .card-grid > div{ min-width: 0; }

    .detail-list{
      margin: 8px 0 0;
      padding-left: 20px;
      color: #475569;
    }
    .detail-list li{
      margin-bottom: 6px;
      word-break: break-word;
      position: relative;
    }
    .detail-list li::marker{
      color: var(--primary);
    }

    .offcanvas{
      border: none !important;
    }
    .offcanvas.offcanvas-end.wide-80{
      width: 80vw !important;
      max-width: 1100px;
      box-shadow: -20px 0 60px rgba(0,0,0,.15);
    }
    @media (max-width: 768px){
      .offcanvas.offcanvas-end.wide-80{ width: 100vw !important; }
    }
    .offcanvas-header{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      padding: 20px 24px;
    }
    .offcanvas-header .offcanvas-title{
      color: #fff !important;
    }
    .offcanvas-header .btn-close{
      filter: brightness(0) invert(1);
      opacity: .8;
    }
    .offcanvas-header .btn-close:hover{
      opacity: 1;
    }
    .offcanvas-body{
      background: #f8fafc;
      padding: 24px;
    }

    .kpi-grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 992px){
      .kpi-grid{ grid-template-columns: 1fr 1fr; }
    }

    .kpi-card{
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      transition: all .2s ease;
    }
    .kpi-card:hover{
      border-color: var(--primary-light);
      box-shadow: var(--shadow-lg);
    }
    .kpi-title{
      font-weight: 800;
      margin-bottom: 12px;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      color: var(--text);
    }
    .kpi-id{
      font-size: .75rem;
      color: #fff;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      padding: 4px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .kpi-meta{
      margin: 0;
      color: #475569;
      font-size: .9rem;
      line-height: 1.6;
    }
    .kpi-meta .k{
      color: var(--primary);
      font-weight: 700;
      margin-right: 6px;
    }

    .seg{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    .seg input{ display:none; }
    .seg label{
      border: 2px solid var(--border);
      background: #f8fafc;
      color: #334155;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      font-size: .875rem;
      transition: all .2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .seg label:hover{
      border-color: var(--primary-light);
      background: #fff;
      transform: translateY(-1px);
    }
    .seg input:checked + label{
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(79,70,229,.15);
      background: #fff;
      color: var(--primary);
    }

    .seg .dot{
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: #cbd5e1;
      display: inline-block;
      box-shadow: inset 0 2px 4px rgba(0,0,0,.1);
    }
    .dot-oui{ background: linear-gradient(135deg, #10b981 0%, #34d399 100%); }
    .dot-non{ background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); }
    .dot-prob{ background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
    .dot-haute{ background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%); }
    .dot-moy{ background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); }
    .dot-faible{ background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); }

    .subtle{ color: var(--muted); font-size: .875rem; font-weight: 500; }

    .section-label{
      font-size: .75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .5px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .empty{
      border: 2px dashed var(--border);
      background: linear-gradient(135deg, #f8fafc 0%, #fff 100%);
      border-radius: 16px;
      padding: 40px 24px;
      text-align: center;
      color: var(--muted);
    }
    .empty i{
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: .5;
    }
    .empty p{
      margin: 0;
      font-size: 1rem;
      font-weight: 500;
    }

    /* Footer */
    .footer{
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: .8rem;
    }
    .footer a{
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }
    .footer a:hover{
      text-decoration: underline;
    }

    /* Floating Export Button */
    .fab-export{
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 14px 20px;
      font-size: .95rem;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
      border: none;
      border-radius: 50px;
      box-shadow: 0 8px 24px rgba(16,185,129,.4), 0 4px 8px rgba(0,0,0,.1);
      cursor: pointer;
      transition: all .25s cubic-bezier(.4,0,.2,1);
    }
    .fab-export:hover{
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 12px 32px rgba(16,185,129,.5), 0 6px 12px rgba(0,0,0,.15);
    }
    .fab-export:active{
      transform: translateY(-1px) scale(0.98);
    }
    .fab-export i{
      font-size: 1.1rem;
    }
    @media (max-width: 576px){
      .fab-export{
        bottom: 16px;
        right: 16px;
        padding: 12px 16px;
        font-size: .85rem;
      }
      .fab-export span{
        display: none;
      }
      .fab-export{
        border-radius: 50%;
        padding: 16px;
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header-bar">
    <div class="container-fluid" style="max-width: 1400px; margin: 0 auto; padding: 0 20px;">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <h4><i class="bi bi-clipboard2-data me-2"></i>Tableau de suivi — Engagements & KPI</h4>
          <div class="subtitle">Clique sur un engagement pour voir et renseigner ses KPI (sauvegarde auto)</div>
        </div>
        <div class="upload-compact">
          <input id="fileInput" class="form-control form-control-sm" type="file" accept=".json,application/json" style="background: rgba(255,255,255,.9);">
          <button id="btnLoadCST" class="btn btn-sm btn-light"><i class="bi bi-cloud-download me-1"></i>Charger données CST</button>
        </div>
      </div>
    </div>
  </div>

  <div class="app-shell">

    <div class="topbar">
      <div class="stats-grid">
        <div class="stat">
          <div class="label"><i class="bi bi-journal-text me-1"></i>Engagements</div>
          <div id="statEngagements" class="value">0</div>
        </div>
        <div class="stat">
          <div class="label"><i class="bi bi-speedometer2 me-1"></i>KPI total</div>
          <div id="statKpi" class="value">0</div>
        </div>
        <div class="stat">
          <div class="label"><i class="bi bi-check-circle me-1"></i>Complétés</div>
          <div id="statDone" class="value">0</div>
        </div>
        <div class="stat">
          <div class="label"><i class="bi bi-clock-history me-1"></i>En cours</div>
          <div id="statOther" class="value">0</div>
        </div>
      </div>

      <div class="controlbar">
        <div class="filters">
          <div class="position-relative">
            <i class="bi bi-search position-absolute" style="left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted);"></i>
            <input id="searchInput" class="form-control form-control-sm" type="text" placeholder="Rechercher..." style="padding-left: 36px;" />
          </div>

          <select id="domainFilter" class="form-select form-select-sm">
            <option value="all">Tous les domaines</option>
          </select>

          <select id="kpiFilter" class="form-select form-select-sm">
            <option value="all">Tous les KPI</option>
          </select>

          <select id="statusFilter" class="form-select form-select-sm">
            <option value="all">Tous les états</option>
            <option value="done">Complété</option>
            <option value="partial">Partiellement complété</option>
            <option value="none">Pas initié</option>
          </select>
        </div>

        <div class="subtle">
          <i class="bi bi-database me-1"></i>Données sauvegardées localement
        </div>
      </div>
    </div>

    <div class="table-wrap">
      <div id="emptyState" class="empty">
        <i class="bi bi-folder2-open d-block"></i>
        <p>Charge un fichier JSON ou clique sur "Charger données CST" pour commencer</p>
      </div>

      <div class="table-responsive" id="tableArea" style="display:none;">
        <table class="table table-borderless align-middle mb-0">
          <thead>
            <tr>
              <th style="width:160px;">Référence</th>
              <th>Engagement</th>
              <th style="width:42%;">Détail de l'engagement</th>
            </tr>
          </thead>
          <tbody id="tbodyEngagements" style="display:flex; flex-direction:column; gap: var(--row-gap); padding-top:10px;"></tbody>
        </table>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      Made by Youssef Chigane / Ui: Tomorrow systems </a>
    </div>

  </div>

  <!-- Floating Export Button -->
  <button id="btnExportExcelSelections" class="fab-export">
    <i class="bi bi-file-earmark-excel"></i>
    <span>Exporter Excel</span>
  </button>

  <!-- Offcanvas KPI -->
  <div class="offcanvas offcanvas-end wide-80" tabindex="-1" id="kpiCanvas" aria-labelledby="kpiCanvasLabel">
    <div class="offcanvas-header">
      <div>
        <h5 class="offcanvas-title" id="kpiCanvasLabel" style="font-weight:900;"><i class="bi bi-speedometer2 me-2"></i>Indicateurs KPI</h5>
        <div id="kpiCanvasSubtitle" class="subtitle" style="color: rgba(255,255,255,.8); font-size: .85rem;"></div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
    </div>
    <div class="offcanvas-body">
      <div id="kpiBody"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const REFERENCE_KEY = "kpi_reference_actions";

    let data = [];
    let actions = loadActions();
    let currentEngagementIndex = null;

    const els = {
      fileInput: document.getElementById("fileInput"),
      btnLoadCST: document.getElementById("btnLoadCST"),
      btnExportExcelSelections: document.getElementById("btnExportExcelSelections"),
      emptyState: document.getElementById("emptyState"),
      tableArea: document.getElementById("tableArea"),
      tbody: document.getElementById("tbodyEngagements"),
      search: document.getElementById("searchInput"),
      statusFilter: document.getElementById("statusFilter"),
      domainFilter: document.getElementById("domainFilter"),
      kpiFilter: document.getElementById("kpiFilter"),
      statEngagements: document.getElementById("statEngagements"),
      statKpi: document.getElementById("statKpi"),
      statDone: document.getElementById("statDone"),
      statOther: document.getElementById("statOther"),
      kpiSubtitle: document.getElementById("kpiCanvasSubtitle"),
      kpiBody: document.getElementById("kpiBody")
    };

    // ---------- Storage ----------
    function loadActions(){
      try{
        const raw = localStorage.getItem(REFERENCE_KEY);
        if(!raw) return { kpi: {} };
        const parsed = JSON.parse(raw);
        if(!parsed || typeof parsed !== "object") return { kpi: {} };
        if(!parsed.kpi) parsed.kpi = {};
        return parsed;
      }catch(e){
        return { kpi: {} };
      }
    }

    function saveActions(){
      localStorage.setItem(REFERENCE_KEY, JSON.stringify(actions));
    }

    // ---------- Helpers ----------
    function safeArray(v){ return Array.isArray(v) ? v : []; }

    function getKpiId(kpiObj){
      return (kpiObj && (kpiObj.ID ?? kpiObj.Id ?? kpiObj.id ?? null));
    }

    function ensureKpiIds(){
      let maxId = 0;

      data.forEach(item => {
        safeArray(item["Indicateurs & KPI"]).forEach(kpi => {
          const id = getKpiId(kpi);
          if(id !== null && id !== undefined){
            const n = Number(id);
            if(Number.isFinite(n)) maxId = Math.max(maxId, n);
          }
        });
      });

      data.forEach(item => {
        safeArray(item["Indicateurs & KPI"]).forEach(kpi => {
          let id = getKpiId(kpi);
          if(id === null || id === undefined || id === ""){
            maxId += 1;
            kpi.ID = maxId;
          }else{
            if(kpi.ID === undefined) kpi.ID = id;
          }
        });
      });
    }

    function computeEngagementState(item){
      const kpis = safeArray(item["Indicateurs & KPI"]);
      if(kpis.length === 0) return "none";

      let filled = 0;
      for(const kpi of kpis){
        const id = String(kpi.ID);
        const d = actions.kpi[id];
        if(d && (d.confidence || d.importance)) filled++;
      }
      if(filled === 0) return "none";
      if(filled === kpis.length) return "done";
      return "partial";
    }

    function stateLabelFr(state){
      if(state === "done") return "Complété";
      if(state === "partial") return "Partiellement complété";
      return "Pas initié";
    }

    function normalizeKey(obj, candidates){
      for(const k of candidates){
        if(obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
      }
      return "";
    }

    function matchesSearch(item, q){
      if(!q) return true;
      const s = q.toLowerCase();

      const ref = String(item["Référence contractuelle"] ?? "").toLowerCase();
      const eng = String(item["Engagement"] ?? "").toLowerCase();
      const details = safeArray(item["Points détaillés de l'engagement"]).join(" ").toLowerCase();

      const kpis = safeArray(item["Indicateurs & KPI"]).map(k => {
        return [
          k.Nom_KPI, k.Définition, k.Unité, k.Périodicité, k.Méthode_de_calcul, k.Source_donnée
        ].filter(Boolean).join(" ");
      }).join(" ").toLowerCase();

      return (ref.includes(s) || eng.includes(s) || details.includes(s) || kpis.includes(s));
    }

    // ---------- ✅ NEW: populate filters ----------
    function fillSelect(selectEl, values, allLabel){
      const current = selectEl.value || "all";
      selectEl.innerHTML = `<option value="all">${escapeHtml(allLabel)}</option>`;
      values.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      });
      // keep selection if possible
      if([..."all", ...values].includes(current)) selectEl.value = current;
      else selectEl.value = "all";
    }

    function refreshFilterOptions(){
      const domains = Array.from(new Set(
        data.map(x => String(x["Domaine"] ?? "").trim()).filter(Boolean)
      )).sort((a,b) => a.localeCompare(b, 'fr'));

      const kpiNames = Array.from(new Set(
        data.flatMap(item =>
          safeArray(item["Indicateurs & KPI"])
            .map(k => String(k.Nom_KPI ?? "").trim())
            .filter(Boolean)
        )
      )).sort((a,b) => a.localeCompare(b, 'fr'));

      fillSelect(els.domainFilter, domains, "Tous les domaines");
      fillSelect(els.kpiFilter, kpiNames, "Tous les KPI");
    }

    // ---------- Excel export ----------
    function buildFlatRows(){
      const rows = [];
      data.forEach((item, engIndex) => {
        const ref = item["Référence contractuelle"] ?? "";
        const domaine = item["Domaine"] ?? "";
        const engagement = item["Engagement"] ?? "";
        const details = safeArray(item["Points détaillés de l'engagement"]).join(" | ");
        const state = computeEngagementState(item);

        safeArray(item["Indicateurs & KPI"]).forEach((kpi, kpiIndex) => {
          const id = String(kpi.ID);
          const saved = actions.kpi[id] || {};

          rows.push({
            engagement_index: engIndex,
            kpi_index: kpiIndex,
            reference_contractuelle: ref,
            domaine: domaine,
            engagement_state: stateLabelFr(state),
            engagement: engagement,
            engagement_details: details,

            kpi_id: id,
            kpi_nom: normalizeKey(kpi, ["Nom_KPI","Nom KPI","Nom","name"]),
            kpi_definition: normalizeKey(kpi, ["Définition","Definition"]),
            kpi_unite: normalizeKey(kpi, ["Unité","Unite","Unit"]),
            kpi_periodicite: normalizeKey(kpi, ["Périodicité","Periodicite"]),
            kpi_methode_calcul: normalizeKey(kpi, ["Méthode_de_calcul","Methode_de_calcul","Méthode de calcul"]),
            kpi_source_donnee: normalizeKey(kpi, ["Source_donnée","Source_donnee","Source"]),

            selection_confiance: saved.confidence || "",
            selection_importance: saved.importance || "",
            selection_updatedAt: saved.updatedAt || ""
          });
        });
      });
      return rows;
    }

    function autoFitColumns(ws, json){
      const keys = Object.keys(json[0] || {});
      const colWidths = keys.map(k => {
        let max = k.length;
        for(const r of json){
          max = Math.max(max, String(r[k] ?? "").length);
        }
        return { wch: Math.min(Math.max(max + 2, 10), 60) };
      });
      ws["!cols"] = colWidths;
    }

    function exportExcelSelections(){
      const rows = buildFlatRows().map(r => ({
        reference_contractuelle: r.reference_contractuelle,
        domaine: r.domaine,
        engagement: r.engagement,
        kpi_id: r.kpi_id,
        kpi_nom: r.kpi_nom,
        selection_confiance: r.selection_confiance,
        selection_importance: r.selection_importance,
        selection_updatedAt: r.selection_updatedAt
      }));

      if(!rows.length){
        alert("Rien à exporter (aucun KPI).");
        return;
      }

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(rows);
      autoFitColumns(ws, rows);
      XLSX.utils.book_append_sheet(wb, ws, "Selections");

      const ts = new Date().toISOString().slice(0,19).replaceAll(":","-");
      XLSX.writeFile(wb, `export_kpi_selections_${ts}.xlsx`);
    }

    // ---------- Render ----------
    function refreshStats(){
      const totalEng = data.length;
      let totalKpi = 0;
      let done = 0;
      let partial = 0;
      let none = 0;

      for(const item of data){
        const kpis = safeArray(item["Indicateurs & KPI"]);
        totalKpi += kpis.length;
        const st = computeEngagementState(item);
        if(st === "done") done++;
        else if(st === "partial") partial++;
        else none++;
      }

      els.statEngagements.textContent = totalEng;
      els.statKpi.textContent = totalKpi;
      els.statDone.textContent = done;
      els.statOther.textContent = (partial + none) + " (" + partial + " / " + none + ")";
    }

    function renderTable(){
      els.tbody.innerHTML = "";
      const q = (els.search.value || "").trim();
      const stFilter = els.statusFilter.value;
      const domFilter = els.domainFilter.value;
      const kpiFilter = els.kpiFilter.value;

      const rows = data
        .map((item, idx) => ({ item, idx, state: computeEngagementState(item) }))
        .filter(({item, state}) => {
          // status
          if(stFilter !== "all" && state !== stFilter) return false;

          // domaine
          if(domFilter !== "all"){
            const dom = String(item["Domaine"] ?? "").trim();
            if(dom !== domFilter) return false;
          }

          // KPI name
          if(kpiFilter !== "all"){
            const names = safeArray(item["Indicateurs & KPI"]).map(k => String(k.Nom_KPI ?? "").trim());
            if(!names.includes(kpiFilter)) return false;
          }

          // global search
          return matchesSearch(item, q);
        });

      if(data.length === 0){
        els.emptyState.style.display = "block";
        els.tableArea.style.display = "none";
        return;
      }

      els.emptyState.style.display = rows.length ? "none" : "block";
      els.tableArea.style.display = "block";

      if(!rows.length){
        els.emptyState.textContent = "Aucun résultat avec ces filtres.";
        return;
      }else{
        els.emptyState.textContent = "Charge un fichier JSON pour afficher les engagements.";
      }

      for(const { item, idx, state } of rows){
        const ref = item["Référence contractuelle"] ?? "";
        const engagement = item["Engagement"] ?? "";
        const details = safeArray(item["Points détaillés de l'engagement"]);

        const tr = document.createElement("tr");
        tr.style.display = "block";
        tr.innerHTML = `
          <td style="display:block;">
            <div class="row-card state-${state}" data-idx="${idx}">
              <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
                <div class="d-flex align-items-center gap-2">
                  <span class="ref-badge">
                    <span class="mini-state"></span>
                    ${escapeHtml(ref)}
                  </span>
                  <span class="subtle">${stateLabelFr(state)}</span>
                </div>
                <span class="subtle">${safeArray(item["Indicateurs & KPI"]).length} KPI</span>
              </div>

              <div class="mt-2 card-grid">
                <div>
                  <div class="subtle">Référence</div>
                  <div class="fw-bold">${escapeHtml(ref)}</div>
                </div>

                <div>
                  <div class="subtle">Engagement</div>
                  <div class="engagement-text">${escapeHtml(engagement)}</div>
                </div>

                <div>
                  <div class="subtle">Détail de l'engagement</div>
                  ${
                    details.length
                      ? `<ul class="detail-list">${details.map(d => `<li>${escapeHtml(d)}</li>`).join("")}</ul>`
                      : `<div class="subtle">—</div>`
                  }
                </div>
              </div>
            </div>
          </td>
        `;

        tr.querySelector(".row-card").addEventListener("click", () => openKpiPanel(idx));
        els.tbody.appendChild(tr);
      }

      refreshStats();
    }

    function openKpiPanel(idx){
      currentEngagementIndex = idx;
      const item = data[idx];
      const ref = item["Référence contractuelle"] ?? "";
      const engagement = item["Engagement"] ?? "";

      els.kpiSubtitle.textContent = `Réf: ${ref} — ${String(engagement).slice(0, 140)}${String(engagement).length > 140 ? "…" : ""}`;
      renderKpis(item);

      const canvasEl = document.getElementById("kpiCanvas");
      const off = bootstrap.Offcanvas.getOrCreateInstance(canvasEl);
      off.show();
    }

    function renderKpis(item){
      const kpis = safeArray(item["Indicateurs & KPI"]);
      if(kpis.length === 0){
        els.kpiBody.innerHTML = `<div class="empty">Aucun KPI pour cet engagement.</div>`;
        return;
      }

      const html = `
        <div class="kpi-grid">
          ${kpis.map((kpi, i) => renderOneKpi(kpi, i)).join("")}
        </div>
      `;
      els.kpiBody.innerHTML = html;

      kpis.forEach((kpi) => {
        const id = String(kpi.ID);
        const confName = `conf_${id}`;
        const impName = `imp_${id}`;

        document.querySelectorAll(`input[name="${confName}"]`).forEach(inp => {
          inp.addEventListener("change", () => {
            ensureActionKpi(id);
            actions.kpi[id].confidence = inp.value;
            actions.kpi[id].updatedAt = new Date().toISOString();
            saveActions();
            onDecisionChanged();
          });
        });

        document.querySelectorAll(`input[name="${impName}"]`).forEach(inp => {
          inp.addEventListener("change", () => {
            ensureActionKpi(id);
            actions.kpi[id].importance = inp.value;
            actions.kpi[id].updatedAt = new Date().toISOString();
            saveActions();
            onDecisionChanged();
          });
        });
      });
    }

    function ensureActionKpi(id){
      if(!actions.kpi[id]) actions.kpi[id] = { confidence: "", importance: "", updatedAt: "" };
    }

    function onDecisionChanged(){
      renderTable();
      if(currentEngagementIndex !== null && data[currentEngagementIndex]){
        renderKpis(data[currentEngagementIndex]);
      }
    }

    function renderOneKpi(kpi, idx){
      const id = String(kpi.ID);
      const name = kpi.Nom_KPI ?? `KPI ${idx+1}`;
      const def = kpi.Définition ?? "";
      const unite = kpi.Unité ?? "";
      const periodicite = kpi.Périodicité ?? "";
      const calc = kpi["Méthode_de_calcul"] ?? "";
      const source = kpi["Source_donnée"] ?? "";

      const saved = actions.kpi[id] || {};
      const conf = saved.confidence || "";
      const imp = saved.importance || "";

      const confName = `conf_${id}`;
      const impName  = `imp_${id}`;

      return `
        <div class="kpi-card">
          <div class="kpi-title">
            <div>${escapeHtml(name)}</div>
            <div class="kpi-id">ID: ${escapeHtml(id)}</div>
          </div>

          <p class="kpi-meta mb-2"><span class="k">Définition:</span> ${escapeHtml(def) || "—"}</p>
          <p class="kpi-meta mb-1"><span class="k">Unité:</span> ${escapeHtml(unite) || "—"}</p>
          <p class="kpi-meta mb-1"><span class="k">Périodicité:</span> ${escapeHtml(periodicite) || "—"}</p>
          <p class="kpi-meta mb-1"><span class="k">Calcul:</span> ${escapeHtml(calc) || "—"}</p>
          <p class="kpi-meta mb-2"><span class="k">Source:</span> ${escapeHtml(source) || "—"}</p>

          <div class="mt-3">
            <div class="subtle mb-2"><strong>Confiance</strong> (Oui / Non / Probablement)</div>
            <div class="seg" role="radiogroup" aria-label="Confiance">
              ${radio(confName, id, "Oui", conf === "Oui", "dot-oui")}
              ${radio(confName, id, "Non", conf === "Non", "dot-non")}
              ${radio(confName, id, "Probablement", conf === "Probablement", "dot-prob")}
            </div>
          </div>

          <div class="mt-3">
            <div class="subtle mb-2"><strong>Importance</strong> (Haute / Moyenne / Faible)</div>
            <div class="seg" role="radiogroup" aria-label="Importance">
              ${radio(impName, id, "Haute", imp === "Haute", "dot-haute")}
              ${radio(impName, id, "Moyenne", imp === "Moyenne", "dot-moy")}
              ${radio(impName, id, "Faible", imp === "Faible", "dot-faible")}
            </div>
          </div>
        </div>
      `;
    }

    function radio(groupName, id, value, checked, dotClass){
      const inputId = `${groupName}_${value}_${id}`.replace(/\s+/g,'_');
      return `
        <div>
          <input type="radio" id="${escapeAttr(inputId)}" name="${escapeAttr(groupName)}" value="${escapeAttr(value)}" ${checked ? "checked" : ""}>
          <label for="${escapeAttr(inputId)}">
            <span class="dot ${dotClass}"></span>
            ${escapeHtml(value)}
          </label>
        </div>
      `;
    }

    // ---------- Events ----------
    els.fileInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if(!file) return;

      try{
        const text = await file.text();
        const parsed = JSON.parse(text);

        if(!Array.isArray(parsed)){
          alert("Le fichier JSON doit être un tableau (array) d'objets.");
          return;
        }

        data = parsed;
        ensureKpiIds();

        actions = loadActions();
        saveActions();

        refreshFilterOptions();   // ✅ NEW
        renderTable();
      }catch(err){
        console.error(err);
        alert("Impossible de lire ce fichier. Vérifie qu'il s'agit d'un JSON valide.");
      }finally{
        e.target.value = "";
      }
    });

    els.search.addEventListener("input", renderTable);
    els.statusFilter.addEventListener("change", renderTable);
    els.domainFilter.addEventListener("change", renderTable); // ✅ NEW
    els.kpiFilter.addEventListener("change", renderTable);    // ✅ NEW

    els.btnLoadCST.addEventListener("click", async () => {
      els.btnLoadCST.disabled = true;
      els.btnLoadCST.textContent = "Chargement...";

      try {
        const response = await fetch("CST_KPI.json");
        if (!response.ok) {
          throw new Error(`Erreur HTTP: ${response.status}`);
        }
        const parsed = await response.json();

        if (!Array.isArray(parsed)) {
          alert("Le fichier CST_KPI.json doit être un tableau (array) d'objets.");
          return;
        }

        data = parsed;
        ensureKpiIds();
        actions = loadActions();
        saveActions();

        refreshFilterOptions();
        renderTable();
      } catch (err) {
        console.error(err);
        alert("Impossible de charger CST_KPI.json. Vérifiez que le fichier existe.");
      } finally {
        els.btnLoadCST.disabled = false;
        els.btnLoadCST.textContent = "Charger données CST";
      }
    });

    els.btnExportExcelSelections.addEventListener("click", exportExcelSelections);

    // ---------- Utils ----------
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){ return escapeHtml(str); }

    // Initial
    renderTable();
    refreshStats();
  </script>
</body>
</html>
